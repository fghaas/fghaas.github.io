
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index,follow" />


    <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../../theme/pygments/github.min.css">

    <link rel="stylesheet" 
    href="../../../theme/tipuesearch/tipuesearch.min.css" />


  <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/solid.css">

  <link rel="stylesheet" type="text/css" href="/css/override.css">

  <link rel="shortcut icon" href="https://xahteiwi.eu/favicon.svg" type="image/x-icon">
  <link rel="icon" href="https://xahteiwi.eu/favicon.svg" type="image/x-icon">


  <link href="https://xahteiwi.eu/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="xahteiwi.eu Atom">

  <link href="https://xahteiwi.eu/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="xahteiwi.eu RSS">


<script defer data-domain="xahteiwi.eu" src="https://plausible.io/js/plausible.js"></script>

 

<meta name="author" content="Florian Haas" />
<meta name="description" content="When you allow one of your OpenStack tenants a large number of routers, they may not be getting as many as you think they will." />
<meta name="keywords" content="OpenStack">


  <meta property="og:site_name" content="xahteiwi.eu"/>
  <meta property="og:title" content="1,000 routers per tenant? Think again!"/>
  <meta property="og:description" content="When you allow one of your OpenStack tenants a large number of routers, they may not be getting as many as you think they will."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../../resources/hints-and-kinks/1000-routers-per-tenant-think-again/"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2018-12-08 00:00:00+00:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../../author/florian-haas.html">
  <meta property="article:section" content="hints-and-kinks"/>
  <meta property="article:tag" content="OpenStack"/>
  <meta property="og:image" content="https://xahteiwi.eu/images/avatar.jpg">

  <title>xahteiwi.eu &ndash; 1,000 routers per tenant? Think again!</title>


</head>
<body >

<aside>
  <div>
    <a href="../../../">
      <img src="https://xahteiwi.eu/images/avatar.jpg" alt="" title="">
    </a>

    <h1>
      <a href="../../../"></a>
    </h1>


    <form class="navbar-search" action="../../../search.html" role="search">
      <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
    </form>


    <ul class="social">
      <li>
        <a class="sc-mastodon"
rel="me"           href="https://mastodon.social/@xahteiwi"
           target="_blank">
          <i class="fa-brands fa-mastodon"></i>
        </a>
      </li>
      <li>
        <a class="sc-linkedin"
           href="https://www.linkedin.com/in/fghaas"
           target="_blank">
          <i class="fa-brands fa-linkedin"></i>
        </a>
      </li>
      <li>
        <a class="sc-github"
           href="https://github.com/fghaas"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>

<nav>
  <a href="../../../">Home</a>

  <a href="/category/hints-and-kinks.html">Tech</a>
  <a href="/category/presentations.html">Talks</a>
  <a href="/category/blog.html">Thoughts</a>
  <a href="">​</a>
  <a href="/about/">About</a>
  <a href="/comments/">Comments</a>
  <a href="/legal/">Legal</a>
  <a href="/privacy/">Privacy</a>
  <a href="">​</a>
  <a href="/categories.html">Categories</a>
  <a href="/tags.html">Tags</a>
  <a href="">​</a>

  <a href="https://xahteiwi.eu/feeds/all.atom.xml">Atom</a>

  <a href="https://xahteiwi.eu/feeds/all.rss.xml">RSS</a>
</nav>

<article class="single">
  <header>
      
    <h1 id="1000-routers-per-tenant-think-again">1,000 routers per tenant? Think again!</h1>
    <p>
      Posted on Sat 08 December 2018 in <a href="../../../category/hints-and-kinks.html">hints-and-kinks</a>

        &#8226; 4 min read
    </p>
  </header>


  <div>
    <h2>Neutron quotas</h2>
<p>As with all other OpenStack services, Neutron uses a fairly extensive
quota system. An OpenStack admin can give a tenant<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> a quota limit
on networks, routers, port, subnets, IPv6 subnetpools, and many other
object types.</p>
<p>Most OpenStack deployments set the default per-tenant quota at 10
routers. <strong>However, nothing stops an admin from setting a much higher
router quota, including one above 255. When such a quota change has
been applied to your tenant, you’re in for a surprise.</strong></p>
<h2>HA routers</h2>
<p>Way back in the OpenStack Juno release, we got high-availability
support for Neutron routers. This means that, assuming you have more
than one network gateway node that can host them, your virtual routers
will work in an automated active/backup configuration. </p>
<p>In effect, what Neutron does for you is that for every subnet that is
plugged into the router — and for which it therefore acts as the
default gateway — the gateway address binds to a keepalived-backed
VRRP interface. On one of the network nodes that interface is active,
and on the others it’s in standby. <strong>If your network node goes down,
keepalived makes sure that the subnets’ default gateway IPs come up on
the other node.</strong> The keepalived configuration is completely
abstracted away from the user; the Neutron L3 agent happily takes care
of all of it.</p>
<p>In addition, in case a network node is up but has lost upstream
network connectivity itself, whereas another is still available that
retains it, HA routers also fail over in order to ensure connectivity
for your VMs.</p>
<h2>The catch: one HA router network per tenant</h2>
<p>In order to enable HA routers, Neutron creates <em>one</em> administrative
network per tenant, over which it runs VRRP traffic. In order to tell
apart all the keepalived instances that it manages on that network, it
assigns each an individual Virtual Router ID or VRID.</p>
<p>And here’s the problem: <strong><a href="https://tools.ietf.org/html/rfc5798">RFC
5798</a> defines the VRID to be an
8-bit integer.</strong> That means that if you use HA routers, then setting a
router quota over 255 is useless — Neutron will run out of VRIDs in
the administrative network, before your tenant can ever hit the quota.</p>
<p>And this is a hard limit; there’s really not much that Neutron can do
about this — apart from starting to spin up additional administrative
networks once it runs out of VRIDs in the first one, but that likely
would be a pretty involved change. <strong>Thus, at least for the time
being, if you want more than 255 <em>highly-available</em> virtual routers,
you’ll have to spread them across multiple tenants.</strong></p>
<p>What’s more is that Neutron is not very forthcoming about this
limitation itself: an attempt to create an HA router beyond the limit
simply leads to an <code>Unknown</code> error from the Neutron API endpoint.</p>
<h2>Wait, what if I really don’t <em>need</em> HA routers?</h2>
<p>Well, firstly you probably do want them, really. But that aside,
let’s assume for a moment that you actually don’t. Or rather, that
it’s more important for you to have more than 255 routers in a single
tenant, than for any of them to be highly available. So you create
routers with the <code>ha</code> flag set to <code>False</code>, simple, right?</p>
<p>It turns out that you probably won’t be able to do that. And that’s
not because you can’t change a router’s <code>ha</code> flag without first
temporarily disabling it — that’s not going to hurt you much if you’ve
already decided you don’t need HA; in such a case a brief router blip
will be acceptable. Instead, it’s because (at the time of writing)
<strong>the default Neutron policy restricts setting the <code>ha</code> flag on a
router to admins only.</strong></p>
<p>So <em>if</em> you want to be able to disable a router’s HA capability,
you’ll first need to convince your cloud service provider to override
the following default entries in Neutron’s <code>policy.json</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">"create_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_only"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"get_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_only"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"update_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_only"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>… and instead set them as follows:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">"create_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_or_owner"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"get_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_or_owner"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"update_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_or_owner"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>If your cloud service provider deploys Neutron with
<a href="https://docs.openstack.org/openstack-ansible/latest/">OpenStack-Ansible</a>,
they can define this in the <a href="https://docs.openstack.org/openstack-ansible-os_neutron/latest/">following
variable</a>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">neutron_policy_overrides</span><span class="p">:</span>
<span class="w">    </span><span class="s">"create_router:ha"</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">"rule:admin_or_owner"</span>
<span class="w">    </span><span class="s">"get_router:ha"</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">"rule:admin_or_owner"</span>
<span class="w">    </span><span class="s">"update_router:ha"</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">"rule:admin_or_owner"</span>
</code></pre></div>
<p>Once the policy has been overridden in this manner, you should be able
to create a new router with:</p>
<div class="highlight"><pre><span></span><code>openstack<span class="w"> </span>router<span class="w"> </span>create<span class="w"> </span>--no-ha<span class="w"> </span>&lt;name&gt;
</code></pre></div>
<p>And modify an existing router’s high-availability flag with:</p>
<div class="highlight"><pre><span></span><code>openstack<span class="w"> </span>router<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--disable<span class="w"> </span>&lt;name&gt;
openstack<span class="w"> </span>router<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--no-ha<span class="w"> </span>&lt;name&gt;
openstack<span class="w"> </span>router<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--enable<span class="w"> </span>&lt;name&gt;
</code></pre></div>
<h2><em>Is</em> my router HA, really?</h2>
<p>In relation to what I described above, you may want to <em>find out</em>
whether one of your routers is configured to be highly available in
the first place. You’d expect to easily be able to do this with an
<code>openstack router show</code> command:</p>
<p>Alas, what you see in the example above <em>is</em> indeed a highly-available
router, <strong>so why does it clearly report its <code>ha</code> flag as being
<code>False</code>?</strong></p>
<p>Well, that’s another consequence of that default Neutron policy, in
combination with rather unintuitive behavior by the <code>openstack</code>
command line client. You see, this part of the aforementioned policy</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">"get_router:ha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rule:admin_only"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>… means you’re not even allowed to <em>query</em> the <code>ha</code> flag if you’re
not an admin, and when the <code>openstack</code> client is asked to display a
boolean value that the user is not allowed to even read, then it
always displays <code>False</code>.</p>
<hr/>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>I’m very sorry, I still can’t force myself to call a tenant it a
“project”, as I find that term profoundly illogical: the proper
term for the concept being discussed here is multitenancy, not
multiprojectcy. <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../../tag/openstack.html">OpenStack</a>
    </p>
  </div>






</article>

<footer>
<p>
  &copy; 2024  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike License</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " xahteiwi.eu ",
  "url" : "../../..",
  "image": "https://xahteiwi.eu/images/avatar.jpg",
  "description": ""
}
</script>
</body>
</html>